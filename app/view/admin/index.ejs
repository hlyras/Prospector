<!DOCTYPE html>
<html style="height:100%;">

<head>
  <%- include('./../partials/head.ejs') %>
  <title>WA Messager</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <%- include('./header/main.ejs') %>

  <section id="prospector-container" class="container" style="height:100%;">
    <%- include('./contact/main.ejs') %>
    <%- include('./chat/main.ejs') %>
  </section>
</body>

<footer>
  <%- include('./../partials/footer.ejs') %>

  <script src="/js/messenger.js"></script>
  <script src="/js/contact/main.js"></script>
  <script src="/js/contact/map.js"></script>
  <script src="/js/contact/list.js"></script>
  <script src="/js/contact/agenda.js"></script>
  <script src="/js/message/main.js"></script>
  <script src="/js/speech/main.js"></script>

  <%- include('./message/main.ejs') %>
  <%- include('./agenda/main.ejs') %>
  <%- include('./websocket.ejs') %>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      websocketConnect();

      const VAPID_PUBLIC_KEY = "<%= VAPID_PUBLIC %>";

      if (!("serviceWorker" in navigator)) {
        alert("Navegador n√£o suporta push");
        return;
      }

      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        return;
      }

      const registration = await navigator.serviceWorker.register("/js/webpush/main.js");

      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: VAPID_PUBLIC_KEY
      });

      let response = await fetch("/webpush/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(subscription)
      });
    });
  </script>
</footer>

</html>