<%- include('./div.ejs') %>
<%- include('./reaction.ejs') %>

<script>
  async function receivedMessage({ data, message }) {
    const correctJid = message.jid || null;
    console.log('passou', correctJid);
    if (!correctJid) { return; }


    let contact_box = document.getElementById("contact-box");
    let contact_div = document.getElementById(`contact-${correctJid}`);

    if (!contact_div) {
      let contact = (await API.response(Contact.filter, {
        jid: correctJid
      }))[0];
      if (!contact) return;

      contact_div = contactDiv(contact);
      contact_box.prepend(contact_div);
    }

    if (currentChatContact == correctJid) {
      let message_div = messageDiv(message);
      document.getElementById("message-box").append(message_div);
    }

    contact_box.prepend(contact_div);

    let profile_picture = document.getElementById(`profile-picture-${correctJid}`);

    if (data.profile_picture && profile_picture?.dataset.empty) {
      let response = await API.response(Contact.update, {
        jid: correctJid,
        profile_picture: data.profile_picture
      }, profile_picture);

      response.done && (profile_picture.src = data.profile_picture);
    } else {
      if ((data.profile_picture && profile_picture.src) && profile_picture.src != data.profile_picture) {
        let response = await API.response(Contact.update, {
          jid: correctJid,
          profile_picture: data.profile_picture
        }, profile_picture);
      }
    }

    let last_message_datetime = document.getElementById(`last-message-datetime-${correctJid}`);
    last_message_datetime.innerHTML = "";
    last_message_datetime.innerHTML = lib.splitTextBy(lib.timestampToFulldate(message.datetime), " ")[1];

    let last_message = document.getElementById(`last-message-${correctJid}`);
    last_message.innerHTML = "";

    if (message.type == "text") {
      last_message.innerHTML = lib.string.cut(message.content, 30);
    }

    if (message.type == "image") { last_message.innerHTML = "üì∏ Foto"; }
    if (message.type == "video") { last_message.innerHTML = "üé¨ V√≠deo"; }
    if (message.type == "audio") { last_message.innerHTML = "üîä √Åudio"; }
    if (message.type == "reaction") { last_message.innerHTML = message.content; }
  };

  function beep() {
    new Audio("/audios/bip.mp3").play();
  }
</script>