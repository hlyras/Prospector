<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Colar e salvar imagem (PNG ou WEBP)</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f3f4f6
    }

    .card {
      width: 720px;
      max-width: 95%;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08)
    }

    h1 {
      margin: 0 0 8px;
      font-size: 18px
    }

    p {
      margin: 0 0 16px;
      color: #374151
    }

    .drop {
      border: 2px dashed #d1d5db;
      border-radius: 10px;
      padding: 28px;
      min-height: 170px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: text;
      background: #fff
    }

    .hint {
      color: #6b7280;
      font-size: 14px
    }

    img.preview {
      max-width: 100%;
      max-height: 360px;
      border-radius: 8px;
      border: 1px solid #e5e7eb
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 12px
    }

    input[type=text],
    select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb
    }

    input[type=text] {
      flex: 1
    }

    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 0;
      background: #111827;
      color: white;
      cursor: pointer
    }

    small.note {
      display: block;
      margin-top: 10px;
      color: #9ca3af
    }
  </style>
</head>

<body>
  <main class="card">
    <h1>Cole uma imagem (Ctrl+V) e salve em PNG ou WEBP</h1>
    <p>Clique dentro da área e pressione <kbd>Ctrl</kbd>+<kbd>V</kbd>. A imagem será convertida automaticamente.</p>

    <div id="drop" class="drop" tabindex="0">
      <div class="hint">Cole uma imagem (Ctrl+V) — preview aparecerá aqui</div>
      <img id="preview" class="preview" style="display:none" />
    </div>

    <div class="controls">
      <input id="filename" type="text" placeholder="nome-do-arquivo" value="pasted-image">
      <select id="format">
        <option value="png">PNG</option>
        <option value="webp">WEBP</option>
      </select>
      <button id="saveBtn">Salvar</button>
    </div>
    <small class="note">Funciona em navegadores modernos.</small>
  </main>

  <script>
    const drop = document.getElementById('drop');
    const preview = document.getElementById('preview');
    const filenameInput = document.getElementById('filename');
    const formatSelect = document.getElementById('format');
    const saveBtn = document.getElementById('saveBtn');

    let lastImageBlob = null;

    async function convertImage(blob, format) {
      return await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          canvas.toBlob((outBlob) => {
            if (outBlob) resolve(outBlob);
            else reject(new Error('Falha ao converter'));
          }, `image/${format}`);
        };
        img.onerror = () => reject(new Error('Erro ao carregar imagem'));
        img.src = URL.createObjectURL(blob);
      });
    }

    function downloadBlob(blob, filename) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    async function handleBlob(blob) {
      const format = formatSelect.value;
      const converted = await convertImage(blob, format);
      lastImageBlob = converted;

      preview.src = URL.createObjectURL(converted);
      preview.style.display = '';
      drop.querySelector('.hint').style.display = 'none';

      const safeName = (filenameInput.value || 'pasted-image').replace(/[^a-zA-Z0-9-_]/g, '_');
      downloadBlob(converted, safeName + '.' + format);
    }

    window.addEventListener('paste', async (e) => {
      if (!e.clipboardData) return;

      for (const item of e.clipboardData.items) {
        if (item.type.startsWith('image')) {
          const file = item.getAsFile();
          e.preventDefault();
          await handleBlob(file);
          return;
        }
      }

      const text = e.clipboardData.getData('text');
      if (/^https?:\/\/.*\.(png|jpe?g|webp|gif)$/i.test(text)) {
        try {
          const res = await fetch(text);
          const blob = await res.blob();
          await handleBlob(blob);
        } catch {
          alert('Erro ao baixar imagem por URL.');
        }
      }
    });

    drop.addEventListener('click', () => drop.focus());

    saveBtn.addEventListener('click', () => {
      if (!lastImageBlob) return alert('Cole uma imagem primeiro.');
      const format = formatSelect.value;
      const safeName = (filenameInput.value || 'pasted-image').replace(/[^a-zA-Z0-9-_]/g, '_');
      downloadBlob(lastImageBlob, safeName + '.' + format);
    });
  </script>
</body>

</html>