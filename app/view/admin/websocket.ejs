<script>
  function websocketConnect() {
    return new Promise((resolve, reject) => {
      let protocol = window.location.protocol == "https:" ? "wss:" : "ws:";
      const socketUrl = `${protocol}//${window.location.host}/ws`

      const socket = new WebSocket(socketUrl);

      socket.onopen = function () {
        console.log('Conexão estabelecida...');
        socket.send(JSON.stringify({ type: 'identify', sessionID: 'abc123' }));
      };

      socket.onmessage = (event) => {
        const { data, contact, message, notify_alert } = JSON.parse(event.data);

        console.log(notify_alert);
        console.log('contact', contact);
        console.log('data', data);
        console.log('message', message);

        if (notify_alert) {
          beep();

          if (document.getElementById(`contact-${notify_alert.jid}`)) {
            lib.display(`contact-${notify_alert.jid}-notify`, "");
          }

          lib.display("all-users-icon-notify", "");
          !notify_alert.status && lib.display("all-users-icon-notify", "");
          notify_alert.status == "conectado" && lib.display("conected-icon-notify", "");
          notify_alert.status == "interessado" && lib.display("interested-icon-notify", "");
          notify_alert.status == "demo" && lib.display("demo-icon-notify", "");
          notify_alert.status == "acompanhar" && lib.display("follow-icon-notify", "");
          notify_alert.status == "importante" && lib.display("important-icon-notify", "");
          notify_alert.status == "cliente" && lib.display("customer-icon-notify", "");
          notify_alert.status == "pessoal" && lib.display("personal-icon-notify", "");
        }

        if (data.notify_alert) {
          if (document.getElementById(`contact-${data.jid}`)) {
            lib.display(`contact-${data.jid}-notify`, "");
          }

          lib.display("all-users-icon-notify", "");
          data.conected && lib.display("conected-icon-notify", "");
          data.interested && lib.display("interested-icon-notify", "");
          data.demo && lib.display("demo-icon-notify", "");
        }

        if (!message.jid) { return; }

        if (lib.splitTextBy(message.jid)[0] == "status") {
          return;
        }

        if (message.type == "reaction") {
          return messageReaction(message);
        }

        receivedMessage({ data, message, contact });
      };

      socket.onerror = function (event) {
        let message = 'Erro desconhecido no WebSocket.';

        if (socket.readyState === WebSocket.CLOSED) {
          message = 'Conexão com o servidor foi recusada ou caiu.';
        } else if (socket.readyState === WebSocket.CONNECTING) {
          message = 'Não foi possível conectar ao servidor WebSocket.';
        }

        if (event?.message) {
          message += ' Detalhes: ' + event.message;
        }

        reject(message);
      };

      socket.onclose = function (event) {
        if (event.wasClean) {
          console.log('Conexão fechada limpa');
        } else {
          console.log('Conexão interrompida');
          websocketConnect();
        }

        console.log(`Código: ${event.code} - Motivo: ${event.reason}`);
      };
    });
  };
</script>