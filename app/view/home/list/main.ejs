<div id="contact_map_box" class="box b2-3 container" style="display: none;"></div>
<form id="contact_list_form" class="box b2-3 container">
  <select name="status" class="mobile-box b5 lucida-grande bold border radius-3 padding-8 margin-top-5">
    <!-- <option value="">Todos os status</option> -->
    <option value="Pendente">Pendente</option>
    <option value="Conclu√≠do">Conclu√≠do</option>
  </select>

  <select name="user" class="mobile-box b5 lucida-grande bold border radius-3 padding-8 margin-top-5">
    <% for(let i in users){ %>
    <option value="<%= users[i].id %>"><%=users[i].name %></option>
    <% } %>
  </select>

  <input type="date" name="period_start"
    class="mobile-box b5 lucida-grande bold border radius-3 padding-8 margin-top-5">
  <input type="date" name="period_end" class="mobile-box b5 lucida-grande bold border radius-3 padding-8 margin-top-5">

  <input type="submit" name="submit"
    class="mobile-box b5 btn-act lucida-grande bold noborder radius-3 padding-10 margin-top-5" value="Buscar">
</form>

<div id="contact_list_box" class="box b2-3 container"></div>

<script>
  let randomizeAndRemove = function (array) {
    if (!Array.isArray(array)) {
      throw new Error('O par√¢metro deve ser um array');
    }

    if (array.length === 0) {
      return null;
    }

    const index = Math.floor(Math.random() * array.length);
    return array.splice(index, 1)[0];
  };

  document.addEventListener("DOMContentLoaded", async () => {
    contact_list_form.period_start.value = lib.convertDate(lib.timestampToDate(lib.genTimestamp()));
    contact_list_form.period_end.value = lib.convertDate(lib.timestampToDate(lib.genTimestamp()));

    let contact_maps = await API.response(ContactMap.filter, {});

    contact_list_form.addEventListener("submit", async e => {
      e.preventDefault();
      contactListFilter();
    });

    contactListFilter();
  });

  async function contactListSender(rounds = 1) {
    const contact_lists = await API.response(ContactList.filter, {
      status: "Pendente",
      order: [["created_at", "asc"]]
    });

    if (!contact_lists?.length) {
      console.log('üì≠ Nenhum contato pendente');
      return;
    }

    // apenas os n√£o enviados
    let pending = contact_lists.filter(cl => !cl.sent_datetime);

    if (!pending.length) {
      console.log('‚úÖ Nada para enviar');
      return;
    }

    // usu√°rios fixos
    const baseUsers = [2, 3, 4, 5, 6, 7, 8, 9, 10];

    for (let round = 1; round <= rounds; round++) {
      console.log(`üîÅ Rodada ${round}/${rounds}`);

      // copia os users para essa rodada
      let users = [...baseUsers];

      while (users.length > 0) {
        const user = randomizeAndRemove(users);

        const contact_list = pending.find(
          cl => cl.seller_id === user
        );

        if (!contact_list) {
          console.log(`‚è≠Ô∏è User ${user} sem contatos pendentes`);
          continue;
        }

        const response = await API.response(ContactList.send, {
          id: contact_list.id,
          user_id: user
        });

        if (!response) {
          console.log(`‚ùå Falha ao enviar ${contact_list.id}`);
          continue;
        }

        console.log(`üì§ Enviado ${contact_list.id} por user ${user}`);

        // remove da lista pendente para n√£o reenviar
        pending = pending.filter(p => p.id !== contact_list.id);
      }

      if (!pending.length) {
        console.log('üèÅ Acabaram os contatos pendentes');
        break;
      }
    }

    console.log('‚úÖ Envio finalizado');
  }

  async function contactListFilter() {
    contact_list_box.innerHTML = "";

    let contact_lists = await API.response(ContactList.filter, {
      status: contact_list_form.status.value,
      period_start: contact_list_form.status.value == "Conclu√≠do" ? lib.dateToTimestamp(contact_list_form.period_start.value) : null,
      period_end: contact_list_form.status.value == "Conclu√≠do" ? lib.dateToTimestamp(contact_list_form.period_end.value) + lib.timestampDay() - 1 : null,
      seller_id: contact_list_form.user.value
    });

    let sender_icon = lib.element.icon("b2-3", "50", "images/icon/");

    contact_list_box.append(lib.element.create("input", {
      type: "number",
      id: "contact-list-result",
      disabled: true,
      value: contact_lists.filter(cl => cl.status == "Conclu√≠do").length,
      class: "mobile-box b2 noborder rem20 lucida-grande bold padding-10 center transparent"
    }));

    contact_list_box.append(lib.element.create("input", {
      type: "number",
      id: "contact-list-result",
      disabled: true,
      value: contact_lists.length,
      class: "mobile-box b2 noborder rem20 lucida-grande bold padding-10 center transparent"
    }));

    contact_lists.forEach(contact_list => {
      let contact_list_div = lib.element.create("div", {
        id: `contact-list-jid-${contact_list.jid.split("@")[0]}`,
        class: "box b1 container border radius-5 padding-5 margin-top-5",
        style: `${contact_list.status == "Conclu√≠do"
          ? 'background-color:green;color: #fff;'
          : 'background-color:#fff;color: #000;'}`
      });
      contact_list_box.append(contact_list_div);

      let contact_phone = lib.element.create("div", {
        class: "mobile-box b3 text-shadow-nn-lg padding-5 center pointer"
      }, contact_list.jid.split("@")[0]);
      contact_list_div.append(contact_phone);

      let contact_business = lib.element.create("div", {
        class: "mobile-box b2 text-shadow-nn-lg padding-5 center pointer"
      }, contact_list.business);
      contact_list_div.append(contact_business);

      let send_icon = lib.element.icon("b6", 30, "/images/icon/send.png")
      send_icon.id = `send-icon-contact-${contact_list.jid}`;
      if (!contact_list.sent_datetime) {
        contact_list_div.append(send_icon);
      }

      if (contact_list.status == "Conclu√≠do") {
        if (contact_list.flow_step == 0) {
          let step_icon = lib.element.icon("b6", 30, "/images/icon/all-users.png")
          contact_list_div.append(step_icon);
        }

        if (contact_list.flow_step == 1) {
          let step_icon = lib.element.icon("b6", 30, "/images/icon/all-users.jpg")
          contact_list_div.append(step_icon);
        }

        if (contact_list.flow_step == 2) {
          let step_icon = lib.element.icon("b6", 25, "/images/icon/conected.png")
          contact_list_div.append(step_icon);
        }

        if (contact_list.flow_step == 3) {
          let step_icon = lib.element.icon("b6", 25, "/images/icon/interested.png")
          contact_list_div.append(step_icon);
        }

        if (contact_list.flow_step == 4) {
          let step_icon = lib.element.icon("b6", 25, "/images/icon/demo.png")
          contact_list_div.append(step_icon);
        }
      }

      // events
      contact_phone.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(contact_list.jid.split("@")[0]);
          console.log("Copiado:", contact_list.jid.split("@")[0]);
          // alert("Copiado:", contact_list.jid.split("@")[0]);
        } catch (err) {
          console.error("Erro ao copiar:", err);
        }
      });

      contact_business.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(contact_list.business);
          console.log("Copiado:", contact_list.business);
          // alert("Copiado:", contact_list.jid.split("@")[0]);
        } catch (err) {
          console.error("Erro ao copiar:", err);
        }
      });

      send_icon.addEventListener("click", async () => {
        let response = await API.response(ContactList.send, {
          id: contact_list.id
        });
        if (!response) { return; }

        send_icon.remove();
        // lib.message(response.done);
      });
    });
  };
</script>