<%- include('./div.ejs') %>

<script>
  async function receivedMessage({ data, message }) {
    let contact_div = document.getElementById(`contact-${data.key.remoteJid}`);
    if (!contact_div) {
      let contact_box = document.getElementById("contact-filter-box");

      let contact = (await API.response(Contact.filter, {
        jid: data.key.remoteJid
      }))[0];
      if (!contact) return;

      contact_div = contactDiv(contact);
      contact_box.prepend(contact_div);
    }

    if (currentChatContact == data.key.remoteJid) {
      let message_div = messageDiv(message);
      document.getElementById("message-box").append(message_div);
    }

    let profile_picture = document.getElementById(`profile-picture-${data.key.remoteJid}`);

    if (data.profile_picture && profile_picture?.dataset.empty) {
      let response = await API.response(Contact.update, {
        jid: data.key.remoteJid,
        profile_picture: data.profile_picture
      }, profile_picture);

      response.done && (profile_picture.src = data.profile_picture);
    } else {
      if ((data.profile_picture && profile_picture.src) && profile_picture.src != data.profile_picture) {
        let response = await API.response(Contact.update, {
          jid: data.key.remoteJid,
          profile_picture: data.profile_picture
        }, profile_picture);
      }
    }
  };
</script>