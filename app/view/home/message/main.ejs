<%- include('./div.ejs') %>

<script>
  async function receivedMessage({ data, message }) {
    let contact_box = document.getElementById("contact-box");
    let contact_div = document.getElementById(`contact-${data.key.remoteJid}`);

    if (!contact_div) {
      let contact = (await API.response(Contact.filter, {
        jid: data.key.remoteJid
      }))[0];
      if (!contact) return;

      contact_div = contactDiv(contact);
      contact_box.prepend(contact_div);
    }

    if (currentChatContact == data.key.remoteJid) {
      let message_div = messageDiv(message);
      document.getElementById("message-box").append(message_div);
    }

    contact_box.prepend(contact_div);

    let profile_picture = document.getElementById(`profile-picture-${data.key.remoteJid}`);

    if (data.profile_picture && profile_picture?.dataset.empty) {
      let response = await API.response(Contact.update, {
        jid: data.key.remoteJid,
        profile_picture: data.profile_picture
      }, profile_picture);

      response.done && (profile_picture.src = data.profile_picture);
    } else {
      if ((data.profile_picture && profile_picture.src) && profile_picture.src != data.profile_picture) {
        let response = await API.response(Contact.update, {
          jid: data.key.remoteJid,
          profile_picture: data.profile_picture
        }, profile_picture);
      }
    }

    let last_message_datetime = document.getElementById(`last-message-datetime-${data.key.remoteJid}`);
    last_message_datetime.innerHTML = "";
    last_message_datetime.innerHTML = lib.splitTextBy(lib.timestampToFulldate(message.datetime), " ")[1];

    let last_message = document.getElementById(`last-message-${data.key.remoteJid}`);
    last_message.innerHTML = "";

    if (message.type == "conversation" || message.type == "text") {
      last_message.innerHTML = lib.string.cut(message.content, 30);
    }

    if (message.type == "image") { last_message.innerHTML = "üì∏ Foto"; }
    if (message.type == "video") { last_message.innerHTML = "üé¨ V√≠deo"; }
    if (message.type == "audio") { last_message.innerHTML = "üîä √Åudio"; }
  };
</script>