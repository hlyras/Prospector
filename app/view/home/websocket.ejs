<script>
  function websocketConnect() {
    return new Promise((resolve, reject) => {
      // const socketUrl = 'ws://127.0.0.1:3005/ws';
      // const socketUrl = 'ws://192.168.132.3:3005/ws';
      const socketUrl = 'wss://ec348e326adc.ngrok-free.app/ws';
      const socket = new WebSocket(socketUrl);

      socket.onopen = function () {
        console.log('Conexão estabelecida...');
        socket.send(JSON.stringify({ type: 'identify', sessionID: 'abc123' }));
      };

      socket.onmessage = (event) => {
        const { data, message } = JSON.parse(event.data);

        console.log(data);

        // if (data.notify_alert) {
        //   // if (document.getElementById(`contact-${data.jid}`)) {
        //   //   lib.display(`contact-${data.jid}-notify`, "");
        //   // }

        //   if (data.interested || data.demo) {
        //     beep();
        //   }

        //   // lib.display("all-users-icon-notify", "");
        //   // data.conected && lib.display("conected-icon-notify", "");
        //   // data.interested && lib.display("interested-icon-notify", "");
        //   // data.demo && lib.display("demo-icon-notify", "");
        //   return;
        // }

        // if (!data.key.remoteJidAlt) {
        //   return;
        // }

        // if (lib.splitTextBy(data.key.remoteJidAlt)[0] == "status") {
        //   return;
        // }

        // if (message.type == "reaction") {
        //   // return messageReaction(message);
        //   return;
        // }

        console.log('data.key.fromMe', data.key.fromMe);

        if (data.key.fromMe) {
          let contact_list_div = document.getElementById(`contact-list-jid-${data.key.remoteJidAlt.split("@")[0]}`);

          if (contact_list_div) {
            if (contact_list_div.style.backgroundColor != 'green') {
              contact_list_div.style.backgroundColor = "green";
              contact_list_div.style.color = "#fff";

              let contact_list_result = document.getElementById(`contact-list-result`);
              contact_list_result.value = parseInt(contact_list_result.value) + 1;
            }
          } else {
            contact_list_div = document.getElementById(`contact-list-jid-${data.key.remoteJid.split("@")[0]}`);

            if (contact_list_div) {
              if (contact_list_div.style.backgroundColor != 'green') {
                contact_list_div.style.backgroundColor = "green";
                contact_list_div.style.color = "#fff";

                let contact_list_result = document.getElementById(`contact-list-result`);
                contact_list_result.value = parseInt(contact_list_result.value) + 1;
              }
            }
          }
        }
      };

      socket.onerror = function (event) {
        let message = 'Erro desconhecido no WebSocket.';

        if (socket.readyState === WebSocket.CLOSED) {
          message = 'Conexão com o servidor foi recusada ou caiu.';
        } else if (socket.readyState === WebSocket.CONNECTING) {
          message = 'Não foi possível conectar ao servidor WebSocket.';
        }

        if (event?.message) {
          message += ' Detalhes: ' + event.message;
        }

        reject(message);
      };

      socket.onclose = function (event) {
        if (event.wasClean) {
          console.log('Conexão fechada limpa');
        } else {
          console.log('Conexão interrompida');
          websocketConnect();
        }

        console.log(`Código: ${event.code} - Motivo: ${event.reason}`);
      };
    });
  };
</script>