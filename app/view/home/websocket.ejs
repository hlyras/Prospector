<script>
  function websocketConnect() {
    return new Promise((resolve, reject) => {
      // const socketUrl = 'ws://127.0.0.1:3005/ws';
      // const socketUrl = 'ws://192.168.0.5:3005/ws';
      const socketUrl = 'wss://d56826c65bd4.ngrok-free.app/ws';

      const socket = new WebSocket(socketUrl);

      socket.onopen = function () {
        console.log('Conexão estabelecida... Aguardando key');
        socket.send(JSON.stringify({ type: 'identify', sessionID: 'abc123' }));
      };

      socket.onmessage = (event) => {
        console.log('Mensagem recebida:', JSON.parse(event.data));

        const data = JSON.parse(event.data);

        if (!data.content) { return; }

        let message_box = document.getElementById("message-box");
        let message_div = messageDiv(data);
        message_box.append(message_div);
      };

      socket.onerror = function (event) {
        let message = 'Erro desconhecido no WebSocket.';

        if (socket.readyState === WebSocket.CLOSED) {
          message = 'Conexão com o servidor foi recusada ou caiu.';
        } else if (socket.readyState === WebSocket.CONNECTING) {
          message = 'Não foi possível conectar ao servidor WebSocket.';
        }

        // Tenta pegar mais detalhes se disponíveis
        if (event?.message) {
          message += ' Detalhes: ' + event.message;
        }

        lib.message(message);

        // Rejeita com string clara (ou usa lib.message)
        reject(message);
      };

      socket.onclose = function (event) {
        if (event.wasClean) {
          lib.message('Conexão fechada limpa');
        } else {
          lib.message('Conexão interrompida');
          websocketConnect();
        }

        lib.message(`Código: ${event.code} - Motivo: ${event.reason}`);
      };
    });
  };
</script>